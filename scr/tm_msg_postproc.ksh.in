#!/bin/ksh

APPLDIR=@prefix@

# Set some basic environment:
. ${HOME}/.profile_msg_oper

# $1: N-slots back in time from now

if test -f ${MSG_PP_OPER_MODE_FILE}; then
    . ${APPLDIR}/cfg/.profile_msgpp
    # Check that no session is already active 
    if [ -n "`ps -edalf | grep "msg_remap_all_Oper.py" | grep -v grep`" ]; then 
	{ echo "***msg_remap_all_Oper already active, abort****" >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_remap_all_Oper.log 2>&1; exit ; } 
    fi
    if [ -n "`ps -edalf | grep "msg_rgb_remap_all_Oper.py" | grep -v grep`" ]; then 
	{ echo "***msg_rgb_remap_all_Oper already active, abort****" >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_rgb_remap_all_Oper.log 2>&1; exit ; } 
    fi
    if [ -n "`ps -edalf | grep "msg_PutProducts2ftpserver.py" | grep -v grep`" ]; then 
	{ echo "***msg_PutProducts2ftpserver already active, abort****" >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msgPutProducts2ftpserver.log 2>&1; exit ; } 
    fi
    if [ -n "`ps -edalf | grep "msg_write2hdf.py" | grep -v grep`" ]; then 
	{ echo "***msg_write2hdf already active, abort****" >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_write2hdf.log 2>&1; exit ; } 
    fi
    # otherwise continue
else
    echo "host `uname -n` is not the current operational node..."
    echo "...don't run NWCSAF/MSG smhi post-processing."
    exit
fi

python ${APPLDIR}/scr/msg_remap_all_Oper.py 1 >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_remap_all_Oper.log 2>&1
python ${APPLDIR}/scr/msg_rgb_remap_all_Oper.py 1 >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_rgb_remap_all_Oper.log 2>&1
python ${APPLDIR}/scr/msg_PutProducts2ftpserver.py >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msgPutProducts2ftpserver.log 2>&1
python ${APPLDIR}/scr/msg_write2hdf.py 1 >> /local_disk/opt/NWCSAF_MSG_PP/current/log/msg_write2hdf.log 2>&1
